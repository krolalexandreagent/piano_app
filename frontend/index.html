<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Piano Map</title>
    <style>
        /*
         * The map must have an explicit height to appear on the page. The
         * height is set to 100vh (viewport height) so it fills the entire
         * screen. Width is 100% to span the full width of the page.
         */
        #map {
            height: 100vh;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Root element for our React application -->
    <div id="root"></div>

    <!-- React and ReactDOM from unpkg for convenience -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Load Google Maps JavaScript API. Replace YOUR_API_KEY with an actual API key. -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>
    <!-- We will use Babel to allow JSX in our inline script -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        /**
         * Main React component that renders a map and populates it with piano
         * markers fetched from the backend. On mount it waits for the Google
         * Maps API to load, then retrieves the piano locations from the
         * backend ("/pianos" endpoint) and displays each one as a marker.
         */
        function App() {
            const [pianos, setPianos] = React.useState([]);

            // Fetch piano locations once when the component mounts
            React.useEffect(() => {
                fetch('/pianos')
                    .then(response => response.json())
                    .then(data => setPianos(data))
                    .catch(err => console.error('Error fetching pianos:', err));
            }, []);

            // Initialize the map and add markers once both Google Maps and piano
            // data are available. This effect runs every time pianos change.
            React.useEffect(() => {
                // Helper to wait for Google Maps library to load
                function ensureGoogleMapsLoaded(callback) {
                    if (window.google && window.google.maps) {
                        callback();
                    } else {
                        // Retry after a short delay if not yet loaded
                        setTimeout(() => ensureGoogleMapsLoaded(callback), 200);
                    }
                }

                ensureGoogleMapsLoaded(() => {
                    // Determine an initial map centre. Default to London if no pianos yet.
                    const defaultCenter = { lat: 51.5074, lng: -0.1278 };
                    const first = pianos && pianos.length > 0 ? pianos[0] : null;
                    const center = first
                        ? {
                            lat: first.latitude !== undefined ? first.latitude : first.Latitude,
                            lng: first.longitude !== undefined ? first.longitude : first.Longitude
                        }
                        : defaultCenter;

                    // Create the map instance on the #map element. If a map already exists
                    // we replace it by recreating (Google Maps API does not support
                    // re-initialization on the same element without a refresh).
                    const mapElement = document.getElementById('map');
                    const map = new window.google.maps.Map(mapElement, {
                        center: center,
                        zoom: pianos && pianos.length > 0 ? 10 : 5,
                    });

                    // Add a marker for each piano
                    (pianos || []).forEach(p => {
                        const lat = p.latitude !== undefined ? p.latitude : p.Latitude;
                        const lng = p.longitude !== undefined ? p.longitude : p.Longitude;
                        const name = p.name !== undefined ? p.name : p.Name;
                        new window.google.maps.Marker({
                            position: { lat: lat, lng: lng },
                            map: map,
                            title: name,
                        });
                    });
                });
            }, [pianos]);

            // Render the map container. React does not control the inside of this div;
            // Google Maps API will populate it.
            return <div id="map"></div>;
        }

        // Render the App component into the root element
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>